#!/bin/bash

set -e

# Declare associative arrays for device mapping
declare -A DEVICE_MAP
declare -A DEVICE_TYPE

# Function to find the HDMI card (the one with available HDMI stereo outputs)
find_hdmi_card() {
    pactl list cards | awk '
    BEGIN { current_card = "" }
    /^Card #/ { current_card = ""; next }
    /^[[:space:]]*Name: / { current_card = $2; next }
    /^[[:space:]]*output:hdmi-stereo(-extra[0-9]+)?: / && /available: yes/ {
        if (current_card != "") {
            hdmi_cards[current_card] = 1
        }
    }
    END {
        for (c in hdmi_cards) {
            print c
            exit
        }
    }'
}

# Function to create friendly display name
friendly_name() {
    local desc="$1"
    
    desc=$(echo "$desc" | sed -e 's/ Output$//' \
                               -e 's/Digital Stereo (HDMI)/HDMI/' \
                               -e 's/Digital Stereo (HDMI \([0-9]\))/HDMI Port \1/' \
                               -e 's/^HDMI \([0-9]\)$/HDMI Port \1/' \
                               -e 's/^HDMI$/Primary HDMI/')
    
    echo "$desc"
}

# Find analog sink
ANALOG_SINK=$(pactl list sinks short | awk '/analog-stereo/ {print $2; exit}')

# Find HDMI card name
HDMI_CARD=$(find_hdmi_card)

if [ -z "$HDMI_CARD" ]; then
    notify-send "üîä Audio Switcher" "No HDMI audio device detected"
    exit 1
fi

# Build device map with friendly names
MENU_OPTIONS=""

if [ -n "$ANALOG_SINK" ]; then
    FRIENDLY="üéß Headphones / Speakers"
    DEVICE_MAP["$FRIENDLY"]="$ANALOG_SINK"
    DEVICE_TYPE["$FRIENDLY"]="analog"
    MENU_OPTIONS+="$FRIENDLY\n"
fi

# Extract HDMI profiles
HDMI_PROFILES=$(pactl list cards | awk -v card="$HDMI_CARD" '
BEGIN { found = 0 }
/^[[:space:]]*Name: / { found = ($2 == card) }
found && /^[[:space:]]*output:hdmi-stereo(-extra[0-9]+)?: / {
    profile = $1
    sub(/:$/, "", profile)
    
    temp = $0
    sub(/ \(sinks:.*\)/, "", temp)
    
    desc = temp
    sub(/^[^:]*:[^:]*: */, "", desc)
    
    if (index($0, "available: yes") > 0) {
        print profile "|" desc
    }
}
')

# Add HDMI devices to map
while IFS='|' read -r profile desc; do
    [ -z "$profile" ] && continue
    
    display_name=$(friendly_name "$desc")
    FRIENDLY="üñ•Ô∏è  $display_name"
    
    DEVICE_MAP["$FRIENDLY"]="$profile"
    DEVICE_TYPE["$FRIENDLY"]="hdmi"
    MENU_OPTIONS+="$FRIENDLY\n"
done <<< "$HDMI_PROFILES"

# Show menu with rofi - display only friendly names
CHOICE=$(echo -e "$MENU_OPTIONS" | sed '/^$/d' | \
    rofi -dmenu -i -p "üîä Audio Output" \
         -theme-str 'window {width: 450px;} listview {lines: 8;}')

[ -z "$CHOICE" ] && exit 0

# Get device identifier from map
SELECTED="${DEVICE_MAP[$CHOICE]}"
TYPE="${DEVICE_TYPE[$CHOICE]}"

# Extract display name for notification (remove icon)
DISPLAY_NAME=$(echo "$CHOICE" | sed -E 's/^[üéßüñ•Ô∏è]+ *//')

if [[ "$TYPE" == "analog" ]]; then
    pactl set-default-sink "$SELECTED"
    notify-send "üîä Audio Switched" "Now using: $DISPLAY_NAME"
else
    # Switch card profile to selected HDMI output
    pactl set-card-profile "$HDMI_CARD" "$SELECTED"
    
    # Wait briefly for the new sink to appear
    sleep 0.3
    
    # Find the newly activated HDMI sink
    NEW_SINK=$(pactl list sinks short | awk '/hdmi/ {print $2; exit}')
    
    if [ -n "$NEW_SINK" ]; then
        pactl set-default-sink "$NEW_SINK"
    fi
    
    notify-send "üîä Audio Switched" "Now using: $DISPLAY_NAME"
fi

# Move all existing streams to the new default sink
pactl list sink-inputs short | awk '{print $1}' | \
    xargs -r -I{} pactl move-sink-input {} @DEFAULT_SINK@